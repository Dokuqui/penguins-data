services:
  mongodb:
    image: mongo:5.0
    container_name: penguin_mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  cassandra:
    image: cassandra:4.1
    container_name: penguin_cassandra
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=PenguinCluster
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
    volumes:
      - cassandra_data:/var/lib/cassandra
    healthcheck:
      test: [ "CMD-SHELL", "[ $$(nodetool statusgossip) = running ]" ]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:6.2
    container_name: penguin_redis
    ports:
      - "6379:6379"

  spark-env:
    build: .
    container_name: penguin_spark
    ports:
      - "8888:8888" # Jupyter
      - "4040:4040" # Spark UI
      - "8501:8501" # Streamlit Dashboard
      - "8000:8000" # FastAPI
    volumes:
      - .:/home/jovyan/work
    environment:
      - JUPYTER_TOKEN=penguin
    depends_on:
      mongodb:
        condition: service_healthy
      cassandra:
        condition: service_healthy
    command: >
      bash -c "nohup python -m uvicorn work.src.api:app --host 0.0.0.0 --port 8000 > /tmp/api.log 2>&1 &
               nohup python -m streamlit run work/src/app.py --server.address 0.0.0.0 > /tmp/streamlit.log 2>&1 &
               /usr/local/bin/start-notebook.sh"

volumes:
  mongo_data:
  cassandra_data:
